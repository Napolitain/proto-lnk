syntax = "proto3";

package config;

option go_package = "github.com/napolitain/solver-lnk/proto";

// Building types enum
enum BuildingType {
  BUILDING_UNKNOWN = 0;
  LUMBERJACK = 1;
  QUARRY = 2;
  ORE_MINE = 3;
  FARM = 4;
  WOOD_STORE = 5;
  STONE_STORE = 6;
  ORE_STORE = 7;
  KEEP = 8;
  ARSENAL = 9;
  LIBRARY = 10;
  TAVERN = 11;
  MARKET = 12;
  FORTIFICATIONS = 13;
}

// Technology types enum
enum Technology {
  TECH_UNKNOWN = 0;
  LONGBOW = 1;
  CROP_ROTATION = 2;
  YOKE = 3;
  CELLAR_STOREROOM = 4;
  STIRRUP = 5;
  CROSSBOW = 6;
  SWORDSMITH = 7;
  HORSE_ARMOUR = 8;
  BEER_TESTER = 9;
  WHEELBARROW = 10;
  WEAPONSMITH = 11;
  ARMOURSMITH = 12;
  IRON_HARDENING = 13;
  POISON_ARROWS = 14;
  HORSE_BREEDING = 15;
  FLAMING_ARROWS = 16;
  BLACKSMITH = 17;
  MAP_OF_AREA = 18;
  CISTERN = 19;
  FORTRESS_CONSTRUCTION = 20;
}

// Unit types enum
enum UnitType {
  UNIT_UNKNOWN = 0;
  SPEARMAN = 1;
  SWORDSMAN = 2;
  ARCHER = 3;
  CROSSBOWMAN = 4;
  HORSEMAN = 5;
  LANCER = 6;
  HANDCART = 7;
  OXCART = 8;
}

// Resource types enum
enum ResourceType {
  RESOURCE_UNKNOWN = 0;
  WOOD = 1;
  STONE = 2;
  IRON = 3;
  FOOD = 4;
}

// Building level in config
message BuildingLevel {
  BuildingType type = 1;
  int32 level = 2;
}

// Resource amount
message Resource {
  ResourceType type = 1;
  double amount = 2;
}

// Unit count
message UnitCount {
  UnitType type = 1;
  int32 count = 2;
}

// CastleConfig represents input configuration for castle solver
message CastleConfig {
  // Current building levels (ALL buildings must be specified)
  repeated BuildingLevel building_levels = 1;

  // Current resources
  repeated Resource resources = 2;

  // Already researched technologies
  repeated Technology researched_technologies = 3;
}

// UnitsConfig represents input configuration for units solver
message UnitsConfig {
  // Available food for units (default: 4265)
  int32 food_available = 1;

  // Resource production per hour (default: 1161)
  int32 resource_production_per_hour = 2;

  // Market distance in fields (default: 25)
  int32 market_distance_fields = 3;

  // Existing units (optional)
  repeated UnitCount existing_units = 4;
}

// Target levels for buildings
message TargetLevels {
  repeated BuildingLevel targets = 1;
}

// Request to solve castle build order
message SolveRequest {
  CastleConfig castle_config = 1;
  TargetLevels target_levels = 2;
}

// A single building upgrade action
message BuildingAction {
  BuildingType building_type = 1;
  int32 from_level = 2;
  int32 to_level = 3;
  int32 start_time_seconds = 4;
  int32 end_time_seconds = 5;
  repeated Resource costs = 6;
  int32 food_used = 7;
  int32 food_capacity = 8;
}

// A single research action
message ResearchAction {
  Technology technology = 1;
  int32 start_time_seconds = 2;
  int32 end_time_seconds = 3;
  repeated Resource costs = 4;
  string technology_name = 5;  // Human-readable name for techs not in enum
}

// Action type enum for unified timeline
enum ActionType {
  ACTION_UNKNOWN = 0;
  ACTION_BUILDING = 1;
  ACTION_RESEARCH = 2;
  ACTION_UNIT_TRAINING = 3;
}

// Unit training action (for future use)
message UnitTrainingAction {
  UnitType unit_type = 1;
  int32 count = 2;
  int32 start_time_seconds = 3;
  int32 end_time_seconds = 4;
  repeated Resource costs = 5;
}

// Unified action that can be building, research, or unit training
message Action {
  ActionType type = 1;
  int32 start_time_seconds = 2;
  int32 end_time_seconds = 3;
  
  // One of these will be set based on type
  BuildingAction building = 4;
  ResearchAction research = 5;
  UnitTrainingAction unit_training = 6;
}

// Recommended army composition when build order is complete
message UnitsRecommendation {
  // Recommended unit counts
  repeated UnitCount unit_counts = 1;
  
  // Total food used by this composition
  int32 total_food = 2;
  
  // Trading throughput (resources per hour)
  double total_throughput = 3;
  
  // Defense stats
  int32 defense_vs_cavalry = 4;
  int32 defense_vs_infantry = 5;
  int32 defense_vs_artillery = 6;
  
  // Silver income per hour
  double silver_per_hour = 7;
  
  // Whether build order is complete (all targets reached)
  bool build_order_complete = 8;
}

// Response from solver
message SolveResponse {
  // Full build order (legacy - use timeline for new integrations)
  repeated BuildingAction building_actions = 1;
  repeated ResearchAction research_actions = 2;
  
  // Unified timeline - all actions in chronological order
  repeated Action timeline = 8;
  
  // Next immediate action to execute (unified - replaces next_action and next_research_action)
  Action next_immediate_action = 9;
  
  // Legacy: Next building action (deprecated, use next_immediate_action)
  BuildingAction next_action = 3;
  
  // Legacy: Next research action (deprecated, use next_immediate_action)
  ResearchAction next_research_action = 6;
  
  // Total time to complete all targets (seconds)
  int32 total_time_seconds = 4;
  
  // Strategy used
  string strategy = 5;
  
  // Units recommendation (populated when build order is complete)
  UnitsRecommendation units_recommendation = 7;
}

// Castle Solver Service
service CastleSolverService {
  // Solve returns the optimal build order for a castle
  rpc Solve(SolveRequest) returns (SolveResponse);
  
  // GetNextAction returns only the next immediate action (lightweight)
  rpc GetNextAction(SolveRequest) returns (BuildingAction);
}
